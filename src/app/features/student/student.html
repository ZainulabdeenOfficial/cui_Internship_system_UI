<div class="container py-4">
  <h2 class="mb-3">Student</h2>

  <div class="alert alert-info d-flex justify-content-between align-items-center" role="alert">
    <span>See full guidance, eligibility, deliverables, and evaluation scheme.</span>
    <a routerLink="/guidance" class="btn btn-sm btn-outline-primary">Open Guidance</a>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item" *ngIf="!isApproved()"><button type="button" class="nav-link" [class.active]="currentTab==='applications'" (click)="selectTab('applications')">Internship Approval</button></li>
    <li class="nav-item" *ngIf="selectedId"><button type="button" class="nav-link" [class.active]="currentTab==='assignment'" (click)="selectTab('assignment')">Assignment & Agreement</button></li>
    <li class="nav-item" *ngIf="isApproved()"><button type="button" class="nav-link" [class.active]="currentTab==='logs'" (click)="selectTab('logs')">Weekly Logs</button></li>
    <li class="nav-item" *ngIf="isApproved()"><button type="button" class="nav-link" [class.active]="currentTab==='reports'" (click)="selectTab('reports')">Reports</button></li>
    <li class="nav-item" *ngIf="isApproved()"><button type="button" class="nav-link" [class.active]="currentTab==='assignments'" (click)="selectTab('assignments')">Assignments</button></li>
  <!-- Complaints moved to separate page -->
    <li class="nav-item" *ngIf="isApproved()"><button type="button" class="nav-link" [class.active]="currentTab==='marks'" (click)="selectTab('marks')">Marks</button></li>
  </ul>

  <!-- Assignment and Approval Status -->
  <div class="card mb-3" *ngIf="selectedStudent() as ss">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center">
      <span><strong>Status:</strong> <span class="badge" [class.text-bg-success]="ss.approved" [class.text-bg-secondary]="!ss.approved">{{ ss.approved ? 'Approved' : 'Pending Approval' }}</span></span>
      <span><strong>Faculty Supervisor:</strong> {{ facultyName(ss.facultyId) }}</span>
      <span><strong>Site Supervisor:</strong> {{ siteName(ss.siteId) }} <small class="text-muted">{{ siteEmail(ss.siteId) }}</small></span>
    </div>
  </div>

  

  <!-- Old Approval & Agreement form removed — AppEx-A used as single internship approval form -->

  <!-- Create Internship Request removed from student UI per request -->

  <!-- Internship Agreement removed from student UI; AppEx-A is the single approval path -->

  <!-- Design Proposal and company request lists removed (Evidence flow not used) -->

  <!-- AppEx-A (API-backed) -->
  <div class="card mb-3" *ngIf="selectedId && currentTab==='applications'">
    <div class="card-header">Internship Approval (Section A & B)</div>
    <div class="card-body">
      <form (ngSubmit)="submitAppExAFromForm()" #iapf="ngForm" class="row g-3">
        <div class="col-12"><div class="section-title">Section A: Organization Information</div></div>
        <div class="col-md-6">
          <label class="form-label">Organization Name</label>
          <input class="form-control" [(ngModel)]="appexAForm.organization" name="orgName" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Address</label>
          <input class="form-control" [(ngModel)]="appexAForm.address" name="orgAddress" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Industry Sector</label>
          <input class="form-control" [(ngModel)]="appexAForm.industrySector" name="industrySector" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Contact Person Name</label>
          <input class="form-control" [(ngModel)]="appexAForm.contactName" name="contactName" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Designation</label>
          <input class="form-control" [(ngModel)]="appexAForm.contactDesignation" name="contactDesignation" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Phone Number</label>
          <input class="form-control" [(ngModel)]="appexAForm.contactPhone" name="contactPhone" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-control" [(ngModel)]="appexAForm.contactEmail" name="contactEmail" required />
        </div>

        <div class="col-12"><div class="section-title mt-3">Section B: Internship Position Details</div></div>
        <div class="col-md-3">
          <label class="form-label">Number of Internship Positions</label>
          <input type="number" min="1" class="form-control" [(ngModel)]="appexAForm.numberOfPositions" name="numPositions" />
        </div>
        <div class="col-md-9">
          <label class="form-label">Nature of Internship</label>
          <div class="d-flex flex-wrap gap-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" [(ngModel)]="appexAForm.natureOfInternship.softwareDevelopment" name="nature_sd" />
              <label class="form-check-label">Software Development</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" [(ngModel)]="appexAForm.natureOfInternship.dataScience" name="nature_ds" />
              <label class="form-check-label">Data Science</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" [(ngModel)]="appexAForm.natureOfInternship.networking" name="nature_net" />
              <label class="form-check-label">Networking</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" [(ngModel)]="appexAForm.natureOfInternship.cyberSecurity" name="nature_cy" />
              <label class="form-check-label">Cyber Security</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" [(ngModel)]="appexAForm.natureOfInternship.webMobile" name="nature_web" />
              <label class="form-check-label">Web/Mobile Development</label>
            </div>
            <div class="form-check d-flex align-items-center">
              <input class="form-check-input" type="checkbox" [(ngModel)]="appexAForm.natureOfInternship.otherChecked" name="nature_other_check" />
              <label class="form-check-label me-2">Other:</label>
              <input class="form-control form-control-sm" style="max-width:320px" [(ngModel)]="appexAForm.natureOfInternship.otherText" name="nature_other_text" />
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Internship Location</label>
          <input class="form-control" [(ngModel)]="appexAForm.internshipLocation" name="internshipLocation" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input type="date" class="form-control" [(ngModel)]="appexAForm.startDate" name="iap_start" />
        </div>
        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input type="date" class="form-control" [(ngModel)]="appexAForm.endDate" name="iap_end" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Working Days & Hours</label>
          <input class="form-control" [(ngModel)]="appexAForm.workingDays" placeholder="e.g., Mon-Fri" name="workingDays" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Working Hours</label>
          <input class="form-control" [(ngModel)]="appexAForm.workingHours" placeholder="e.g., 9am-5pm" name="workingHours" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Mode</label>
          <select class="form-select" [(ngModel)]="appexAForm.mode" name="iap_mode">
            <option [ngValue]="'On-Site'">On-Site</option>
            <option [ngValue]="'Virtual'">Virtual</option>
            <option [ngValue]="'Freelancing'">Freelancing Based</option>
          </select>
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-success" [disabled]="!iapf.form.valid" type="submit">Submit Internship Approval</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Internship Assignment & Student Agreement Form (second form) -->
  <div class="card mb-3" *ngIf="selectedId && currentTab==='assignment'">
    <div class="card-header">Internship Assignment & Student Agreement Form</div>
    <div class="card-body">
      <form (ngSubmit)="submitStudentAssignmentAgreement()" #saf="ngForm" class="row g-3">
        <div class="col-12"><strong>Student Information</strong></div>
        <div class="col-md-6">
          <label class="form-label">Full Name</label>
          <input class="form-control" [(ngModel)]="studentAgreementForm.fullName" name="s_fullName" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Registration Number</label>
          <input class="form-control" [(ngModel)]="studentAgreementForm.registrationNumber" name="s_reg" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Degree Program</label>
          <input class="form-control" [(ngModel)]="studentAgreementForm.degreeProgram" name="s_prog" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Semester</label>
          <input class="form-control" [(ngModel)]="studentAgreementForm.semester" name="s_sem" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Contact Number</label>
          <input class="form-control" [(ngModel)]="studentAgreementForm.contactNumber" name="s_contact" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-control" [(ngModel)]="studentAgreementForm.emailAddress" name="s_email" required />
        </div>
        <div class="col-12">
          <label class="form-label">Preferred Internship Field/Domain</label>
          <input class="form-control" [(ngModel)]="studentAgreementForm.preferredField" name="s_field" />
        </div>

        <div class="col-12 mt-2"><strong>Student Internship Agreement Statement</strong></div>
        <div class="col-12">
          <p>
            I, <input class="form-control d-inline-block" style="width:40%" [(ngModel)]="studentAgreementForm.fullName" name="s_name_inline" /> , a student of
            <input class="form-control d-inline-block" style="width:30%" [(ngModel)]="studentAgreementForm.degreeProgram" name="s_prog_inline" /> at
            the university, hereby acknowledge and accept the internship opportunity assigned to me and agree to the statements below.
          </p>
          <ol>
            <li>Abide by the rules, regulations, and code of conduct of the host organization.</li>
            <li>Maintain punctuality, discipline, and professionalism throughout the internship period.</li>
            <li>Complete the tasks and responsibilities assigned to me to the best of my ability.</li>
            <li>Communicate regularly with my academic supervisor and provide updates on my progress.</li>
            <li>Maintain confidentiality of any sensitive information encountered during the internship.</li>
            <li>Submit all required internship reports, evaluations, and documents by the specified deadlines.</li>
          </ol>
        </div>

        <div class="col-md-6 form-check">
          <input class="form-check-input" type="checkbox" [(ngModel)]="studentAgreementForm.acknowledged" name="s_ack" />
          <label class="form-check-label">I agree to the statements above</label>
        </div>
        <!-- Student signature and date removed per UX request -->
        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-success" [disabled]="!saf.form.valid || !studentAgreementForm.acknowledged" type="submit">Submit Assignment & Agreement</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Compact AppEx-A removed; kept the full Section A & B form above as primary internship approval entry -->

  <!-- Internship Design Statement removed (Evidence flow removed) -->

  <!-- One-page Reflective Summary removed from student approval section -->

  <!-- Freelancing / On-site submission aligned with handbook -->
  <!-- Internship Evidence section removed from student UI -->

  <!-- Weekly logs -->
  <div class="card mb-3" *ngIf="selectedId && isApproved() && currentTab==='logs'">
    <div class="card-header">Weekly Logs</div>
    <div class="card-body">
      <form (ngSubmit)="addWeekly()" #w="ngForm" class="row g-3">
        <div class="col-md-2">
          <label class="form-label">Week</label>
          <input type="number" min="1" class="form-control" [(ngModel)]="weekly.week" name="week" required />
        </div>
        <div class="col-md-8">
          <label class="form-label">Note</label>
          <input class="form-control" [(ngModel)]="weekly.note" name="note" required />
        </div>
        <div class="col-md-2 align-self-end">
          <button class="btn btn-primary" [disabled]="!w.form.valid" type="submit">Add</button>
        </div>
      </form>
      <ul class="list-group mt-3">
        <li class="list-group-item" *ngFor="let l of (logs() | paginate: page.logs : pageSize)">Week {{ l.week }} · {{ l.note }} <span class="text-muted">— {{ l.date | date:'short' }}</span></li>
      </ul>
      <app-paginator [total]="logs().length" [(page)]="page.logs" [pageSize]="pageSize"></app-paginator>
    </div>
  </div>

  <!-- Final report -->
  <div class="card mb-3" *ngIf="selectedId && isApproved() && currentTab==='reports'">
    <div class="card-header">Final Report</div>
    <div class="card-body">
      <form (ngSubmit)="addFinal()" #fr="ngForm" class="row g-3">
        <div class="col-md-5">
          <label class="form-label">Title</label>
          <input class="form-control" [(ngModel)]="final.title" name="ftitle" required />
        </div>
        <div class="col-md-7">
          <label class="form-label">Content</label>
          <textarea class="form-control" rows="2" [(ngModel)]="final.content" name="fcontent"></textarea>
        </div>
        <div class="col-12">
          <button class="btn btn-success" [disabled]="!fr.form.valid" type="submit">Submit Final</button>
        </div>
      </form>
      <div class="mt-3">
        <h6>Submitted Reports</h6>
        <ul class="list-group">
          <li class="list-group-item" *ngFor="let r of (reports() | paginate: page.reports : pageSize)">{{ r.type | titlecase }}: {{ r.title }} <span class="text-muted">— {{ r.date | date:'short' }}</span></li>
        </ul>
        <app-paginator [total]="reports().length" [(page)]="page.reports" [pageSize]="pageSize"></app-paginator>
      </div>
    </div>
  </div>

  <!-- Assignments upload -->
  <div class="card mb-3" *ngIf="selectedId && isApproved() && currentTab==='assignments'">
    <div class="card-header">Assignments (PDF, DOCX, PPTX, any file type)</div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label">Select file</label>
          <input id="afile" type="file" class="form-control" (change)="onAssignmentFileChange($event)" />
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary" (click)="submitAssignment()">Upload</button>
        </div>
      </div>
      <div class="table-responsive mt-3" *ngIf="assignments().length; else noAssign">
        <table class="table table-sm align-middle">
          <thead><tr><th>File</th><th>Type</th><th>Size</th><th>Uploaded</th><th>Faculty Mark</th><th></th></tr></thead>
          <tbody>
            <tr *ngFor="let a of assignments()">
              <td>{{ a.fileName }}</td>
              <td>{{ a.fileType }}</td>
              <td>{{ a.fileSize | number }} bytes</td>
              <td>{{ a.uploadedAt | date:'short' }}</td>
              <td>{{ a.facultyMark ?? '-' }}</td>
              <td><button class="btn btn-sm btn-outline-secondary" (click)="downloadAssignment(a)">Download</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noAssign><div class="text-muted">No assignments uploaded yet.</div></ng-template>
    </div>
  </div>

  <!-- Unlock notice removed because tabs are hidden before approval -->

  <!-- Complaints are now a separate page at /complaints -->

  <!-- Marks view (only after Internship Office approval) -->
  <div class="card mb-3" *ngIf="selectedId && isApproved() && currentTab==='marks'">
  <div class="card-header">Marks (Finalized by Internship Office)</div>
    <div class="card-body">
      <div class="row g-3" *ngIf="selectedStudent() as ss">
    <div class="col-md-3"><strong>Faculty:</strong> {{ ss.marks?.faculty ?? 0 }}/40</div>
    <div class="col-md-3"><strong>Internship Office (sub):</strong> {{ ss.marks?.admin ?? 0 }}/20</div>
    <div class="col-md-3"><strong>Site:</strong> {{ ss.marks?.site ?? 0 }}/40</div>
        <div class="col-md-3"><strong>Total:</strong> {{ (ss.marks?.faculty ?? 0) + (ss.marks?.admin ?? 0) + (ss.marks?.site ?? 0) }}</div>
      </div>
      <div class="row g-3 mt-2" *ngIf="selectedStudent() as ss2">
        <div class="col-12 small text-muted">Internship Office breakdown: Proposal {{ ss2.marks?.adminProposal ?? 0 }}/5, Activity Log {{ ss2.marks?.adminLogs ?? 0 }}/5, Final Report {{ ss2.marks?.adminFinal ?? 0 }}/10</div>
      </div>
      <!-- Agreement signatures removed from student view -->
    </div>
  </div>
</div>

<!-- hidden usage to ensure standalone imports are recognized -->
<ng-template #__ensureImports>
  {{ ([] | paginate: 1 : 10).length }}
  <app-paginator [total]="0" [page]="1" [pageSize]="10"></app-paginator>
  <!-- Do not remove: referenced by Student.standalone imports -->
  <!-- existing content above -->
</ng-template>
