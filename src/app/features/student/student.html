<div class="container py-4">
  <h2 class="mb-3">Student</h2>

  <div class="alert alert-info d-flex justify-content-between align-items-center" role="alert">
    <span>See full guidance, eligibility, deliverables, and evaluation scheme.</span>
    <a routerLink="/guidance" class="btn btn-sm btn-outline-primary">Open Guidance</a>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><button class="nav-link" [class.active]="currentTab==='overview'" (click)="selectTab('overview')">Overview</button></li>
    <li class="nav-item" *ngIf="!isApproved()"><button class="nav-link" [class.active]="currentTab==='applications'" (click)="selectTab('applications')">Approval & Agreement</button></li>
    <li class="nav-item"><button class="nav-link" [class.active]="currentTab==='evidence'" (click)="selectTab('evidence')">Design & Evidence</button></li>
    <li class="nav-item" *ngIf="isApproved()"><button class="nav-link" [class.active]="currentTab==='logs'" (click)="selectTab('logs')">Weekly Logs</button></li>
    <li class="nav-item" *ngIf="isApproved()"><button class="nav-link" [class.active]="currentTab==='reports'" (click)="selectTab('reports')">Reports</button></li>
    <li class="nav-item" *ngIf="isApproved()"><button class="nav-link" [class.active]="currentTab==='assignments'" (click)="selectTab('assignments')">Assignments</button></li>
  <!-- Complaints moved to separate page -->
  <li class="nav-item" *ngIf="isApproved()"><button class="nav-link" [class.active]="currentTab==='marks'" (click)="selectTab('marks')">Marks</button></li>
  </ul>

  <!-- Assignment and Approval Status -->
  <div class="card mb-3" *ngIf="selectedStudent() as ss">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center">
      <span><strong>Status:</strong> <span class="badge" [class.text-bg-success]="ss.approved" [class.text-bg-secondary]="!ss.approved">{{ ss.approved ? 'Approved' : 'Pending Approval' }}</span></span>
      <span><strong>Faculty Supervisor:</strong> {{ facultyName(ss.facultyId) }}</span>
      <span><strong>Site Supervisor:</strong> {{ siteName(ss.siteId) }} <small class="text-muted">{{ siteEmail(ss.siteId) }}</small></span>
    </div>
  </div>

  

  <!-- Internship approval/agreement -->
  <div class="card mb-3" *ngIf="selectedId && currentTab==='applications'">
    <div class="card-header">Internship Approval Form</div>
    <div class="card-body">
      <div class="alert alert-secondary py-2" *ngIf="approvals().length as ct">
        <ng-container *ngIf="approvals()[ct-1] as last">
          <div class="d-flex flex-wrap gap-3 align-items-center">
            <span>Latest status: <span class="badge"
              [class.text-bg-secondary]="!last.status || last.status==='pending'"
              [class.text-bg-success]="last.status==='approved'"
              [class.text-bg-danger]="last.status==='rejected'">
              {{ last.status || 'pending' }}
            </span></span>
            <span *ngIf="last.officerComment">Officer comment: <em>{{ last.officerComment }}</em></span>
            <button class="btn btn-sm btn-outline-primary" (click)="loadLatestApproval()">Edit latest and resubmit</button>
          </div>
        </ng-container>
      </div>
      <form (ngSubmit)="submitApproval()" #af="ngForm" class="row g-3">
        <div class="col-12"><div class="section-title">Student Information</div></div>
        <div class="col-md-3">
          <label class="form-label">Name</label>
          <input class="form-control" placeholder="e.g., Ali Ahmed" [(ngModel)]="approval.studentInfo.name" name="sname" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Student ID</label>
          <input class="form-control" placeholder="e.g., FA22-BCS-090" [(ngModel)]="approval.studentInfo.studentId" name="sid" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Program</label>
          <input class="form-control" placeholder="e.g., BCS" [(ngModel)]="approval.studentInfo.program" name="program" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Semester</label>
          <input class="form-control" placeholder="e.g., 7" [(ngModel)]="approval.studentInfo.semester" name="semester" required />
        </div>

        <div class="col-12"><div class="section-title mt-2">Company Details</div></div>
        <div class="col-md-4">
          <label class="form-label">Company Name</label>
          <input class="form-control" placeholder="e.g., ABC Software" [(ngModel)]="approval.company.name" name="cname" required />
        </div>
        <div class="col-md-8">
          <label class="form-label">Address</label>
          <input class="form-control" placeholder="e.g., Main Blvd, Sahiwal" [(ngModel)]="approval.company.address" name="caddress" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Supervisor Name</label>
          <input class="form-control" placeholder="e.g., Mr. Khan" [(ngModel)]="approval.company.supervisorName" name="supname" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Supervisor Email</label>
          <input type="email" class="form-control" placeholder="name@email.com" [(ngModel)]="approval.company.supervisorEmail" name="supemail" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Supervisor Phone</label>
          <input class="form-control" placeholder="e.g., 0300-0000000" [(ngModel)]="approval.company.supervisorPhone" name="supphone" required />
        </div>
        <div class="col-12"><div class="section-title mt-2">Internship Details</div></div>
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input type="date" class="form-control" [(ngModel)]="approval.internship.startDate" name="start" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input type="date" class="form-control" [(ngModel)]="approval.internship.endDate" name="end" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Hours/Week</label>
          <input type="number" min="1" class="form-control" [(ngModel)]="approval.internship.hoursPerWeek" name="hours" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Paid</label>
          <select class="form-select" [(ngModel)]="approval.internship.paid" name="paid" required>
            <option [ngValue]="'Yes'">Yes</option>
            <option [ngValue]="'No'">No</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Objectives</label>
          <textarea class="form-control" rows="2" placeholder="What do you aim to achieve?" [(ngModel)]="approval.objectives" name="objectives" required></textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">Expected Outcomes</label>
          <textarea class="form-control" rows="2" placeholder="What outcomes/products are expected?" [(ngModel)]="approval.outcomes" name="outcomes" required></textarea>
        </div>
        <div class="col-12">
          <button class="btn btn-success" [disabled]="!af.form.valid" type="submit">Submit Approval</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Internship (API-backed) -->
  <div class="card mb-3" *ngIf="selectedId && currentTab==='applications'">
    <div class="card-header">Create Internship Request</div>
    <div class="card-body">
      <form (ngSubmit)="createInternshipSubmit()" #cisf="ngForm" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Type</label>
          <select class="form-select" [(ngModel)]="createInternshipModel.type" name="ctype">
            <option [ngValue]="'ONSITE'">On-site</option>
            <option [ngValue]="'REMOTE'">Remote</option>
            <option [ngValue]="'VIRTUAL'">Virtual</option>
            <option [ngValue]="'HYBRID'">Hybrid</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Site Supervisor ID (optional)</label>
          <input class="form-control" [(ngModel)]="createInternshipModel.siteId" name="csid" placeholder="siteId" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Faculty Supervisor ID (optional)</label>
          <input class="form-control" [(ngModel)]="createInternshipModel.facultyId" name="cfid" placeholder="facultyId" />
        </div>
        <div class="col-md-1 d-grid">
          <button class="btn btn-outline-primary" type="submit">Create</button>
        </div>
      </form>
      <div class="form-text">Requires student authentication; uses bearer token.</div>
    </div>
  </div>

  <div class="card mb-3" *ngIf="selectedId && currentTab==='applications'">
    <div class="card-header">Internship Agreement</div>
    <div class="card-body">
      <form (ngSubmit)="submitAgreement()" #ag="ngForm" class="row g-3">
        <div class="col-md-4 form-check">
          <input class="form-check-input" type="checkbox" id="ack" [(ngModel)]="agreement.policyAcknowledgement" name="ack" />
          <label class="form-check-label" for="ack">I acknowledge program policies</label>
        </div>
        <div class="col-md-4 form-check">
          <input class="form-check-input" type="checkbox" id="conf" [(ngModel)]="agreement.confidentialityAgreement" name="conf" />
          <label class="form-check-label" for="conf">Confidentiality agreement</label>
        </div>
        <div class="col-md-4 form-check">
          <input class="form-check-input" type="checkbox" id="safe" [(ngModel)]="agreement.safetyTraining" name="safe" />
          <label class="form-check-label" for="safe">Safety training completed</label>
        </div>
        <div class="col-md-6">
          <label class="form-label">Student Signature (Name)</label>
          <input class="form-control" [(ngModel)]="agreement.studentSignatureName" name="sig" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Date</label>
          <input type="date" class="form-control" [(ngModel)]="agreement.date" name="adate" required />
        </div>
        <div class="col-12">
          <button class="btn btn-success" [disabled]="!ag.form.valid" type="submit">Submit Agreement</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card mb-3" *ngIf="selectedId && currentTab==='evidence'">
    <div class="card-header">Design Proposal</div>
    <div class="card-body">
      <form (ngSubmit)="submitProposal()" #dp="ngForm" class="row g-3">
        <div class="col-md-5">
          <label class="form-label">Title</label>
          <input class="form-control" [(ngModel)]="proposal.title" name="dtitle" required />
        </div>
        <div class="col-md-7">
          <label class="form-label">Summary</label>
          <textarea class="form-control" rows="2" [(ngModel)]="proposal.content" name="dcontent" required></textarea>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" [disabled]="!dp.form.valid" type="submit">Submit Proposal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Company Request (API-backed) -->
  <div class="card mb-3" *ngIf="selectedId && currentTab==='evidence'">
    <div class="card-header">Request to Add Company</div>
    <div class="card-body">
      <form (ngSubmit)="submitCompanyRequest()" #crf="ngForm" class="row g-3">
        <div class="col-md-4"><label class="form-label">Name</label><input class="form-control" [(ngModel)]="companyRequest.name" name="crname" required /></div>
        <div class="col-md-4"><label class="form-label">Email</label><input type="email" class="form-control" [(ngModel)]="companyRequest.email" name="cremail" required /></div>
        <div class="col-md-4"><label class="form-label">Phone</label><input class="form-control" [(ngModel)]="companyRequest.phone" name="crphone" /></div>
        <div class="col-md-6"><label class="form-label">Address</label><input class="form-control" [(ngModel)]="companyRequest.address" name="craddr" /></div>
        <div class="col-md-6"><label class="form-label">Website</label><input class="form-control" [(ngModel)]="companyRequest.website" name="crweb" placeholder="https://..." /></div>
        <div class="col-md-6"><label class="form-label">Industry</label><input class="form-control" [(ngModel)]="companyRequest.industry" name="crind" /></div>
        <div class="col-md-6"><label class="form-label">Description</label><input class="form-control" [(ngModel)]="companyRequest.description" name="crdesc" /></div>
        <div class="col-12"><label class="form-label">Justification</label><textarea class="form-control" rows="2" [(ngModel)]="companyRequest.justification" name="crjust"></textarea></div>
        <div class="col-12 text-end">
          <button class="btn btn-outline-primary" [disabled]="!crf.form.valid" type="submit">Submit Request</button>
        </div>
      </form>
      <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">My Company Requests</h6>
          <button class="btn btn-sm btn-outline-secondary" (click)="loadMyCompanyRequests()">Refresh</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>When</th><th>Name</th><th>Email</th><th>Status</th></tr></thead>
            <tbody>
              <tr *ngFor="let r of companyRequestsList">
                <td class="small text-muted">{{ r.createdAt | date:'short' }}</td>
                <td>{{ r.name }}</td>
                <td>{{ r.email }}</td>
                <td><span class="badge" [class.text-bg-secondary]="r.status==='PENDING'" [class.text-bg-success]="r.status==='APPROVED'" [class.text-bg-danger]="r.status==='REJECTED'">{{ r.status || 'PENDING' }}</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- AppEx-A (API-backed) -->
  <div class="card mb-3" *ngIf="selectedId && currentTab==='applications'">
    <div class="card-header">AppEx-A (Internship Approval) — Server</div>
    <div class="card-body">
      <div class="d-flex gap-2 mb-2">
        <button class="btn btn-sm btn-outline-secondary" (click)="loadAppExA()">Load from server</button>
      </div>
      <form (ngSubmit)="submitAppExAFromForm()" #axf="ngForm" class="row g-3">
        <div class="col-md-6"><label class="form-label">Organization</label><input class="form-control" [(ngModel)]="appexAForm.organization" name="axorg" required /></div>
        <div class="col-md-6"><label class="form-label">Address</label><input class="form-control" [(ngModel)]="appexAForm.address" name="axaddr" required /></div>
        <div class="col-md-4"><label class="form-label">Industry Sector</label><input class="form-control" [(ngModel)]="appexAForm.industrySector" name="axinds" /></div>
        <div class="col-md-4"><label class="form-label">Contact Name</label><input class="form-control" [(ngModel)]="appexAForm.contactName" name="axcname" required /></div>
        <div class="col-md-4"><label class="form-label">Designation</label><input class="form-control" [(ngModel)]="appexAForm.contactDesignation" name="axcdes" /></div>
        <div class="col-md-4"><label class="form-label">Contact Phone</label><input class="form-control" [(ngModel)]="appexAForm.contactPhone" name="axcphone" required /></div>
        <div class="col-md-4"><label class="form-label">Contact Email</label><input type="email" class="form-control" [(ngModel)]="appexAForm.contactEmail" name="axcemail" required /></div>
        <div class="col-md-4"><label class="form-label">Field</label><input class="form-control" [(ngModel)]="appexAForm.internshipField" name="axfield" /></div>
        <div class="col-md-4"><label class="form-label">Location</label><input class="form-control" [(ngModel)]="appexAForm.internshipLocation" name="axloc" /></div>
        <div class="col-md-4"><label class="form-label">Start Date</label><input type="date" class="form-control" [(ngModel)]="appexAForm.startDate" name="axstart" required /></div>
        <div class="col-md-4"><label class="form-label">End Date</label><input type="date" class="form-control" [(ngModel)]="appexAForm.endDate" name="axend" required /></div>
        <div class="col-md-4"><label class="form-label">Working Days</label><input class="form-control" [(ngModel)]="appexAForm.workingDays" name="axwd" /></div>
        <div class="col-md-4"><label class="form-label">Working Hours</label><input class="form-control" [(ngModel)]="appexAForm.workingHours" name="axwh" /></div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-success" [disabled]="!axf.form.valid" type="submit">Submit AppEx-A</button>
          <button class="btn btn-outline-primary" type="button" (click)="updateAppExAFromForm()">Update AppEx-A</button>
        </div>
      </form>
      <div class="form-text">Requires student authentication; uses bearer token. Server enforces ownership and role.</div>
    </div>
  </div>

  <!-- Internship Design Statement -->
  <div class="card mb-3" *ngIf="selectedId && currentTab==='evidence'">
    <div class="card-header">Internship Design Statement (submit in first week)</div>
    <div class="card-body">
      <form (ngSubmit)="submitDesign()" #dsf="ngForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Career Goal</label>
          <input class="form-control" [(ngModel)]="design.careerGoal" name="career" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Learning Objectives</label>
          <input class="form-control" [(ngModel)]="design.learningObjectives" name="learn" required />
        </div>
        <div class="col-12"><h6 class="text-muted mt-2">Internship Placement Overview</h6></div>
        <div class="col-md-4">
          <label class="form-label">Organization</label>
          <input class="form-control" [(ngModel)]="design.placement.organization" name="org" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Mode</label>
          <select class="form-select" [(ngModel)]="design.placement.mode" name="mode">
            <option [ngValue]="'On-site'">On-site</option>
            <option [ngValue]="'Remote'">Remote</option>
            <option [ngValue]="'Hybrid'">Hybrid</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Functional Area</label>
          <input class="form-control" [(ngModel)]="design.placement.functionalArea" name="func" required />
        </div>
        <div class="col-12">
          <label class="form-label">Overview (optional)</label>
          <textarea class="form-control" rows="2" [(ngModel)]="design.placement.overview" name="ov"></textarea>
        </div>
        <div class="col-12"><h6 class="text-muted mt-2">Supervisor Details</h6></div>
        <div class="col-md-3"><input class="form-control" placeholder="Name" [(ngModel)]="design.supervisor.name" name="sname2" required /></div>
        <div class="col-md-3"><input class="form-control" placeholder="Designation" [(ngModel)]="design.supervisor.designation" name="sdes" required /></div>
        <div class="col-md-3"><input type="email" class="form-control" placeholder="Email" [(ngModel)]="design.supervisor.email" name="semail3" required /></div>
        <div class="col-md-3"><input class="form-control" placeholder="Contact" [(ngModel)]="design.supervisor.contact" name="scont" required /></div>
        <div class="col-md-6">
          <label class="form-label">Scope of Work / Deliverables</label>
          <textarea class="form-control" rows="2" [(ngModel)]="design.scopeAndDeliverables" name="scope" required></textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">Academic Preparation (courses/projects)</label>
          <textarea class="form-control" rows="2" [(ngModel)]="design.academicPreparation" name="prep" required></textarea>
        </div>
        <div class="col-12">
          <label class="form-label">Additional Comments (optional)</label>
          <textarea class="form-control" rows="2" [(ngModel)]="design.comments" name="cmt"></textarea>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" [disabled]="!dsf.form.valid" type="submit">Submit Design Statement</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reflective Summary (one page) -->
  <div class="card mb-3" *ngIf="selectedId">
    <div class="card-header">One-page Reflective Summary</div>
    <div class="card-body">
      <form (ngSubmit)="submitReflective()" #rsf="ngForm" class="row g-3">
        <div class="col-12">
          <label class="form-label">Summary (approx. 1 page)</label>
          <textarea class="form-control" rows="4" [(ngModel)]="reflective.content" name="rcontent" required></textarea>
        </div>
        <div class="col-12">
          <button class="btn btn-success" [disabled]="!rsf.form.valid" type="submit">Submit Reflective Summary</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Freelancing / On-site submission aligned with handbook -->
  <div class="card mb-3" *ngIf="selectedId">
    <div class="card-header">Internship Evidence (Fiverr/Upwork/On-site/Virtual)</div>
    <div class="card-body">
      <div *ngIf="!canSubmitFreelance()" class="alert alert-info mb-3">
        Evidence submitted on
        <strong>{{ lastFreelance()?.createdAt | date:'medium' }}</strong> — status:
        <span class="badge" [class.text-bg-secondary]="lastFreelance()?.status==='pending'" [class.text-bg-success]="lastFreelance()?.status==='approved'" [class.text-bg-danger]="lastFreelance()?.status==='rejected'">
          {{ lastFreelance()?.status || 'pending' }}
        </span>.
        Please wait for Internship Office review.
      </div>
      <form (ngSubmit)="submitFreelance()" #ff="ngForm" class="row g-3" *ngIf="canSubmitFreelance()">
        <div class="col-md-3">
          <label class="form-label">Mode/Platform</label>
          <select class="form-select" [(ngModel)]="freel.platform" name="platform">
            <option [ngValue]="'Fiverr'">Fiverr</option>
            <option [ngValue]="'Upwork'">Upwork</option>
            <option [ngValue]="'OnSite'">On-site</option>
            <option [ngValue]="'Virtual'">Virtual</option>
          </select>
        </div>
        <div class="col-md-3" *ngIf="freel.platform === 'Fiverr' || freel.platform === 'Upwork'">
          <label class="form-label">Profile Authentic</label>
          <select class="form-select" [(ngModel)]="freel.profileAuthentic" name="auth">
            <option [ngValue]="true">Yes</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>
        <div class="col-md-3" *ngIf="freel.platform === 'Fiverr'">
          <label class="form-label">Gigs Completed</label>
          <input type="number" class="form-control" [(ngModel)]="freel.gigsCompleted" name="gigs" min="0" />
        </div>
        <div class="col-md-3" *ngIf="freel.platform === 'Upwork'">
          <label class="form-label">Proposals Applied</label>
          <input type="number" class="form-control" [(ngModel)]="freel.proposalsApplied" name="props" min="0" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Earnings (USD)</label>
          <input type="number" class="form-control" [(ngModel)]="freel.earningsUSD" name="earn" min="0" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Avg Rating</label>
          <input type="number" step="0.1" class="form-control" [(ngModel)]="freel.avgRating" name="rate" min="0" max="5" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Client Feedback (summary)</label>
          <input class="form-control" [(ngModel)]="freel.clientFeedback" name="feedback" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Approval Evidence (summary)</label>
          <input class="form-control" [(ngModel)]="freel.approvalEvidence" name="evidence" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Contract/Chat Summary</label>
          <textarea class="form-control" rows="2" [(ngModel)]="freel.contractSummary" name="contract"></textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">Work Summary / Deliverables</label>
          <textarea class="form-control" rows="2" [(ngModel)]="freel.workSummary" name="work"></textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">Mentor/Supervisor Name</label>
          <input class="form-control" [(ngModel)]="freel.mentorName" name="mentor" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Mentor Contact</label>
          <input class="form-control" [(ngModel)]="freel.mentorContact" name="mcontact" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Technologies/Tools Used</label>
          <input class="form-control" [(ngModel)]="freel.technologies" name="tech" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Logbook/Portfolio Notes</label>
          <textarea class="form-control" rows="2" [(ngModel)]="freel.logbook" name="log"></textarea>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" [disabled]="!evidenceValid()" type="submit">Save Evidence</button>
        </div>
      </form>
      <div class="mt-3" *ngIf="lastFreelance()?.status==='rejected'">
        <div class="alert alert-warning">Your previous evidence was rejected. Please update your details and submit again.</div>
      </div>
      <div class="mt-3">
        <h6>Submitted Evidence</h6>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let f of (freelances() | paginate: page.freel : pageSize)">
            <span>
              <strong>{{ f.platform }}</strong>
              <span class="text-muted">— {{ f.createdAt | date:'short' }}</span>
            </span>
            <span *ngIf="f.platform==='Fiverr'" class="badge" [class.text-bg-success]="meetsFiverr(f)" [class.text-bg-danger]="!meetsFiverr(f)">
              Fiverr: {{ (f.gigsCompleted||0) }} gigs / ${{ (f.earningsUSD||0) }}
            </span>
            <span *ngIf="f.platform==='Upwork'" class="badge" [class.text-bg-success]="meetsUpwork(f)" [class.text-bg-danger]="!meetsUpwork(f)">
              Upwork: {{ (f.proposalsApplied||0) }} proposals / ${{ (f.earningsUSD||0) }}
            </span>
          </li>
  </ul>
  <app-paginator [total]="freelances().length" [(page)]="page.freel" [pageSize]="pageSize"></app-paginator>
      </div>
    </div>
  </div>

  <!-- Weekly logs -->
  <div class="card mb-3" *ngIf="selectedId && isApproved() && currentTab==='logs'">
    <div class="card-header">Weekly Logs</div>
    <div class="card-body">
      <form (ngSubmit)="addWeekly()" #w="ngForm" class="row g-3">
        <div class="col-md-2">
          <label class="form-label">Week</label>
          <input type="number" min="1" class="form-control" [(ngModel)]="weekly.week" name="week" required />
        </div>
        <div class="col-md-8">
          <label class="form-label">Note</label>
          <input class="form-control" [(ngModel)]="weekly.note" name="note" required />
        </div>
        <div class="col-md-2 align-self-end">
          <button class="btn btn-primary" [disabled]="!w.form.valid" type="submit">Add</button>
        </div>
      </form>
      <ul class="list-group mt-3">
        <li class="list-group-item" *ngFor="let l of (logs() | paginate: page.logs : pageSize)">Week {{ l.week }} · {{ l.note }} <span class="text-muted">— {{ l.date | date:'short' }}</span></li>
      </ul>
      <app-paginator [total]="logs().length" [(page)]="page.logs" [pageSize]="pageSize"></app-paginator>
    </div>
  </div>

  <!-- Final report -->
  <div class="card mb-3" *ngIf="selectedId && isApproved() && currentTab==='reports'">
    <div class="card-header">Final Report</div>
    <div class="card-body">
      <form (ngSubmit)="addFinal()" #fr="ngForm" class="row g-3">
        <div class="col-md-5">
          <label class="form-label">Title</label>
          <input class="form-control" [(ngModel)]="final.title" name="ftitle" required />
        </div>
        <div class="col-md-7">
          <label class="form-label">Content</label>
          <textarea class="form-control" rows="2" [(ngModel)]="final.content" name="fcontent"></textarea>
        </div>
        <div class="col-12">
          <button class="btn btn-success" [disabled]="!fr.form.valid" type="submit">Submit Final</button>
        </div>
      </form>
      <div class="mt-3">
        <h6>Submitted Reports</h6>
        <ul class="list-group">
          <li class="list-group-item" *ngFor="let r of (reports() | paginate: page.reports : pageSize)">{{ r.type | titlecase }}: {{ r.title }} <span class="text-muted">— {{ r.date | date:'short' }}</span></li>
        </ul>
        <app-paginator [total]="reports().length" [(page)]="page.reports" [pageSize]="pageSize"></app-paginator>
      </div>
    </div>
  </div>

  <!-- Assignments upload -->
  <div class="card mb-3" *ngIf="selectedId && isApproved() && currentTab==='assignments'">
    <div class="card-header">Assignments (PDF, DOCX, PPTX, any file type)</div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label">Select file</label>
          <input id="afile" type="file" class="form-control" (change)="onAssignmentFileChange($event)" />
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary" (click)="submitAssignment()">Upload</button>
        </div>
      </div>
      <div class="table-responsive mt-3" *ngIf="assignments().length; else noAssign">
        <table class="table table-sm align-middle">
          <thead><tr><th>File</th><th>Type</th><th>Size</th><th>Uploaded</th><th>Faculty Mark</th><th></th></tr></thead>
          <tbody>
            <tr *ngFor="let a of assignments()">
              <td>{{ a.fileName }}</td>
              <td>{{ a.fileType }}</td>
              <td>{{ a.fileSize | number }} bytes</td>
              <td>{{ a.uploadedAt | date:'short' }}</td>
              <td>{{ a.facultyMark ?? '-' }}</td>
              <td><button class="btn btn-sm btn-outline-secondary" (click)="downloadAssignment(a)">Download</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noAssign><div class="text-muted">No assignments uploaded yet.</div></ng-template>
    </div>
  </div>

  <!-- Unlock notice removed because tabs are hidden before approval -->

  <!-- Complaints are now a separate page at /complaints -->

  <!-- Marks view (only after Internship Office approval) -->
  <div class="card mb-3" *ngIf="selectedId && isApproved() && currentTab==='marks'">
  <div class="card-header">Marks (Finalized by Internship Office)</div>
    <div class="card-body">
      <div class="row g-3" *ngIf="selectedStudent() as ss">
    <div class="col-md-3"><strong>Faculty:</strong> {{ ss.marks?.faculty ?? 0 }}/40</div>
    <div class="col-md-3"><strong>Internship Office (sub):</strong> {{ ss.marks?.admin ?? 0 }}/20</div>
    <div class="col-md-3"><strong>Site:</strong> {{ ss.marks?.site ?? 0 }}/40</div>
        <div class="col-md-3"><strong>Total:</strong> {{ (ss.marks?.faculty ?? 0) + (ss.marks?.admin ?? 0) + (ss.marks?.site ?? 0) }}</div>
      </div>
      <div class="row g-3 mt-2" *ngIf="selectedStudent() as ss2">
        <div class="col-12 small text-muted">Internship Office breakdown: Proposal {{ ss2.marks?.adminProposal ?? 0 }}/5, Activity Log {{ ss2.marks?.adminLogs ?? 0 }}/5, Final Report {{ ss2.marks?.adminFinal ?? 0 }}/10</div>
      </div>
      <ng-container *ngIf="agreements() as agrs">
        <div class="row g-3 mt-2" *ngIf="agrs.length > 0">
          <div class="col-12" >
            <small class="text-muted">Latest Agreement Signatures:</small>
            <ng-container *ngIf="agrs[agrs.length-1] as last">
              <div class="small">
                Faculty: {{ last.facultySignatureName || '-' }}
                <span class="text-muted"> — {{ last.facultySignedAt | date:'short' }}</span>
              </div>
              <div class="small">
                Internship Office: {{ last.officeSignatureName || '-' }}
                <span class="text-muted"> — {{ last.officeSignedAt | date:'short' }}</span>
              </div>
            </ng-container>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>

<!-- hidden usage to ensure standalone imports are recognized -->
<ng-template #__ensureImports>
  {{ ([] | paginate: 1 : 10).length }}
  <app-paginator [total]="0" [page]="1" [pageSize]="10"></app-paginator>
  <!-- Do not remove: referenced by Student.standalone imports -->
  <!-- existing content above -->
</ng-template>
