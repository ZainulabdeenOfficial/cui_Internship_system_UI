<div class="container py-4">
  <h2 class="mb-3">Internship Office</h2>

  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">Responsibilities</div>
        <div class="card-body">
          <ul class="mb-0">
            <li>Identify potential host organizations and establish collaborations (MoUs).</li>
            <li>Arrange internship placements for students based on availability and suitability.</li>
            <li>Maintain a complete database of all internship records (placements, evaluations, reports).</li>
            <li>Assign supervisory roles: a faculty supervisor and a site/host supervisor.</li>
            <li>Organize on-campus internship expos and employer meetups with the Industry Liaison Cell.</li>
            <li>Process and respond to feedback and complaints from students, faculty, and host supervisors.</li>
            <li>Support technical infrastructure:
              <ul>
                <li>Assist students with Git/GitHub for version control and portfolios.</li>
                <li>Guide the use of Jira/Trello for project tracking and collaboration.</li>
              </ul>
            </li>
            <li>Collaborate with the Alumni Office to enhance access to opportunities via referrals and networks.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Name</th><th>Email</th><th>Approved</th><th>Faculty</th><th>Site</th><th>Company</th><th>Office Marks</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of students()">
          <td>{{ s.name }}</td>
          <td>{{ s.email }}</td>
          <td>
            <span class="badge" [class.text-bg-success]="s.approved" [class.text-bg-secondary]="!s.approved">{{ s.approved ? 'Yes' : 'No' }}</span>
          </td>
          <td>{{ s.facultyId ? facultyName(s.facultyId) : '-' }}</td>
          <td>{{ siteSupervisorName(s.siteId) }}</td>
          <td>{{ companyName(s.companyId) }}</td>
          <td style="min-width:240px">
            <div class="d-flex gap-2">
              <input type="number" class="form-control form-control-sm" [ngModel]="s.marks?.adminProposal ?? ''" (ngModelChange)="setAdminSubMarks(s.id, $event, s.marks?.adminLogs || 0, s.marks?.adminFinal || 0)" min="0" max="5" placeholder="Proposal /5" />
              <input type="number" class="form-control form-control-sm" [ngModel]="s.marks?.adminLogs ?? ''" (ngModelChange)="setAdminSubMarks(s.id, s.marks?.adminProposal || 0, $event, s.marks?.adminFinal || 0)" min="0" max="5" placeholder="Logs /5" />
              <input type="number" class="form-control form-control-sm" [ngModel]="s.marks?.adminFinal ?? ''" (ngModelChange)="setAdminSubMarks(s.id, s.marks?.adminProposal || 0, s.marks?.adminLogs || 0, $event)" min="0" max="10" placeholder="Final /10" />
            </div>
            <small class="text-muted">Auto total: {{ s.marks?.admin ?? 0 }}/20</small>
          </td>
          <td style="width:600px">
            <button class="btn btn-sm btn-outline-success me-2" (click)="approve(s.id)" [disabled]="s.approved">Approve</button>
            <div class="d-inline-flex gap-2 align-items-center">
              <select class="form-select form-select-sm" [(ngModel)]="facultyId" style="width:160px">
                <option [ngValue]="''">Faculty...</option>
                <option *ngFor="let f of facultyList()" [ngValue]="f.id">{{ f.name }} ({{ f.email }})</option>
              </select>
              <select class="form-select form-select-sm" [(ngModel)]="siteId" style="width:160px">
                <option [ngValue]="''">Site...</option>
                <option *ngFor="let t of siteList()" [ngValue]="t.id">{{ t.name }} ({{ t.email }})</option>
              </select>
              <select class="form-select form-select-sm" [(ngModel)]="companyForStudent[s.id]" style="width:160px">
                <option [ngValue]="''">Company...</option>
                <option *ngFor="let c of companyList()" [ngValue]="c.id">{{ c.name }}</option>
              </select>
              <button class="btn btn-sm btn-primary" (click)="assign(s.id)">Assign</button>
              <button class="btn btn-sm btn-outline-primary" (click)="assignCompanyToStudent(s.id)">Set Company</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="row g-3 mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">Applications (Approval Forms)</div>
        <div class="card-body">
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="pendOnly" [(ngModel)]="showPendingOnly">
            <label class="form-check-label" for="pendOnly">Show only pending</label>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr><th>Student</th><th>Submitted</th><th>Status</th><th>Officer Comment</th><th>Actions</th></tr>
              </thead>
              <tbody>
                <tr *ngFor="let s of students()" [hidden]="!showInApplications(s.id)">
                  <td>
                    <div><strong>{{ s.name }}</strong> <span class="text-muted small">({{ s.email }})</span></div>
                    <div class="small text-muted" *ngIf="latestApproval(s.id) as a">v{{ a.version }} — Company: {{ a.company.name || '-' }} — {{ a.internship.startDate }} → {{ a.internship.endDate }}</div>
                  </td>
                  <td>{{ latestApproval(s.id)?.createdAt | date:'short' }}</td>
                  <td>
                    <span class="badge"
                      [class.text-bg-secondary]="!latestApproval(s.id)?.status || latestApproval(s.id)?.status==='pending'"
                      [class.text-bg-success]="latestApproval(s.id)?.status==='approved'"
                      [class.text-bg-danger]="latestApproval(s.id)?.status==='rejected'">
                      {{ latestApproval(s.id)?.status || 'pending' }}
                    </span>
                    <div class="small text-muted" *ngIf="latestApproval(s.id)?.resolvedAt">{{ latestApproval(s.id)?.resolvedAt | date:'short' }}</div>
                  </td>
                  <td class="w-25">
                    <input class="form-control form-control-sm" placeholder="Comment (optional)" [(ngModel)]="approvalComment[s.id]" name="ac{{s.id}}" />
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <select class="form-select form-select-sm" style="width:140px" [(ngModel)]="approvalDecision[s.id]" name="ad{{s.id}}">
                        <option [ngValue]="''">Choose…</option>
                        <option [ngValue]="'approved'">Approve</option>
                        <option [ngValue]="'rejected'">Reject</option>
                      </select>
                      <button class="btn btn-sm btn-outline-primary" (click)="reviewApproval(s.id)">Apply</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-12">
      <div class="alert alert-info">
        <div class="fw-semibold">Evaluation Scheme</div>
        <ul class="mb-0">
          <li><strong>On-site / Virtual:</strong> Site Supervisor (40) + Faculty Supervisor (40) + Internship Office (20). Office sub-breakdown: Proposal 5, Weekly Logs 5, Final Report 10.</li>
          <li><strong>Freelancing (Fiverr/Upwork):</strong> Supervisor (60) + Internship Office (40). Office sub-breakdown still 5+5+10 but auto-scales to 40.</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">Internship Evaluation Committee (20% Weightage)</div>
        <div class="card-body">
          <p class="mb-2"><strong>Composition:</strong> Notified by the HoD under the convenorship of the In-charge Internship Office with other members as deemed fit.</p>
          <p class="mb-2"><strong>Role:</strong> Evaluate internship report, weekly logs, and technical contribution.</p>
          <p class="mb-0"><strong>Grading:</strong> Assigns 20% of total marks (15% Report Submission, 5% Weekly Log) and submits results to the Internship Office for final processing.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">Weekly Log Compliance</div>
        <div class="card-body">
          <p class="text-muted">Tracks expected vs submitted weekly logs based on the Approval start date.</p>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr><th>Student</th><th>Start</th><th>Expected Weeks</th><th>Submitted</th><th>Status</th></tr>
              </thead>
              <tbody>
                <tr *ngFor="let s of students()">
                  <td>{{ s.name }} <span class="text-muted small">({{ s.email }})</span></td>
                  <td>{{ startDateString(s.id) }}</td>
                  <td>{{ expectedWeeks(s.id) }}</td>
                  <td>{{ logsCount(s.id) }}</td>
                  <td>
                    <span class="badge" [class.text-bg-success]="hasLogThisWeek(s.id)" [class.text-bg-danger]="!hasLogThisWeek(s.id)">
                      {{ hasLogThisWeek(s.id) ? 'This week submitted' : 'Missing this week' }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">Suitable Host Organizations</div>
        <div class="card-body">
          <p class="mb-2">Preferred organizations include:</p>
          <ul>
            <li>Software houses and IT consulting firms</li>
            <li>Banks and telecom companies (IT divisions)</li>
            <li>Startups and tech incubators</li>
            <li>Government departments with IT infrastructure</li>
            <li>Academic institutions and research centers</li>
            <li>NGOs with digital transformation initiatives</li>
          </ul>
          <p class="mb-0">Freelancing via Fiverr/Upwork is acceptable for technical gigs only (e.g., Development, Data Science/AI/ML, APIs/Automation, DevOps/Cloud, Cybersecurity, Database, Testing, UI implementation). Non‑technical roles are not permitted.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">Complaints & Grievances</div>
        <div class="card-body">
          <p class="text-muted">Respond to student complaints submitted to the Internship Office.</p>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead><tr><th>Date</th><th>Student</th><th>Category</th><th>Message</th><th>Status</th><th>Response</th><th>Action</th></tr></thead>
              <tbody>
                <tr *ngFor="let c of complaints()">
                  <td>{{ c.createdAt | date:'short' }}</td>
                  <td>{{ studentName(c.studentId) }}</td>
                  <td>{{ c.category }}</td>
                  <td style="max-width:280px">{{ c.message }}</td>
                  <td>
                    <span class="badge" [class.text-bg-secondary]="c.status==='open'" [class.text-bg-success]="c.status==='resolved'">{{ c.status }}</span>
                  </td>
                  <td style="max-width:260px">{{ c.response || '-' }}</td>
                  <td>
                    <div class="input-group input-group-sm" *ngIf="c.status==='open'">
                      <input class="form-control" placeholder="Type response..." [(ngModel)]="responses[c.id]" name="resp{{c.id}}" />
                      <button class="btn btn-outline-success" (click)="resolve(c.id)">Resolve</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">Requests from Faculty</div>
        <div class="card-body">
          <p class="text-muted">Review requests to add Companies or Site Supervisors submitted by faculty supervisors.</p>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>When</th>
                  <th>Type</th>
                  <th>Details</th>
                  <th>Requested By</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let r of requests()">
                  <td>{{ r.createdAt | date:'short' }}</td>
                  <td>
                    <span class="badge" [class.text-bg-primary]="r.type==='company'" [class.text-bg-info]="r.type==='site'">{{ r.type | titlecase }}</span>
                  </td>
                  <td>
                    <ng-container *ngIf="r.type==='company'; else siteTpl">
                      <div><strong>{{ r.name }}</strong></div>
                      <div class="text-muted small">{{ r.address || '-' }}</div>
                    </ng-container>
                    <ng-template #siteTpl>
                      <div><strong>{{ requestPrimary(r) }}</strong></div>
                      <div class="text-muted small">{{ requestSecondary(r) }}</div>
                    </ng-template>
                  </td>
                  <td>{{ facultyName(r.requestedByFacultyId) }}</td>
                  <td>
                    <span class="badge"
                      [class.text-bg-secondary]="r.status==='pending'"
                      [class.text-bg-success]="r.status==='approved'"
                      [class.text-bg-danger]="r.status==='rejected'">
                      {{ r.status }}
                    </span>
                    <div class="small text-muted" *ngIf="r.resolvedAt">{{ r.resolvedAt | date:'short' }}</div>
                  </td>
                  <td>
                    <div class="d-flex gap-2" *ngIf="r.status==='pending'">
                      <button class="btn btn-sm btn-outline-success" (click)="approveRequest(r.id)">Approve</button>
                      <button class="btn btn-sm btn-outline-danger" (click)="rejectRequest(r.id)">Reject</button>
                    </div>
                    <div class="small text-muted" *ngIf="r.status!=='pending'">—</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr class="my-4" />
  <h3 class="mb-3">Internship Officers</h3>
  <div class="row g-3 align-items-end">
    <div class="col-md-4">
      <label class="form-label">Name</label>
      <input class="form-control" [(ngModel)]="officer.name" name="oname" />
    </div>
    <div class="col-md-4">
      <label class="form-label">Email</label>
      <input type="email" class="form-control" [(ngModel)]="officer.email" name="oemail" />
    </div>
    <div class="col-md-4">
      <button class="btn btn-primary" (click)="addOfficer()">Add Officer</button>
    </div>
  </div>
  <ul class="list-group mt-3">
    <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let o of officers()">{{ o.name }} <span class="text-muted">{{ o.email }}</span></li>
  </ul>

  <hr class="my-4" />
  <h3 class="mb-3">Faculty Supervisors</h3>
  <div class="row g-3 align-items-end">
    <div class="col-md-4">
      <label class="form-label">Name</label>
      <input class="form-control" [(ngModel)]="faculty.name" name="fname" />
    </div>
    <div class="col-md-4">
      <label class="form-label">Email</label>
      <input type="email" class="form-control" [(ngModel)]="faculty.email" name="femail" />
    </div>
    <div class="col-md-3">
      <label class="form-label">Department</label>
      <input class="form-control" [(ngModel)]="faculty.department" name="fdept" />
    </div>
    <div class="col-md-3">
      <label class="form-label">Password</label>
      <input type="password" class="form-control" [(ngModel)]="faculty.password" name="fpass" />
    </div>
    <div class="col-md-1 d-grid">
      <button class="btn btn-primary" (click)="addFaculty()">Add</button>
    </div>
  </div>
  <ul class="list-group mt-3">
    <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let f of facultyList()">
      <div class="me-2">
        <div>{{ f.name }} — <span class="text-muted">{{ f.email }}</span></div>
        <div class="small text-muted">Password: {{ f.password ? 'set' : 'not set' }}</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <input class="form-control form-control-sm" style="width:160px" placeholder="New password" [(ngModel)]="facultyNewPw[f.id]" name="fpw{{f.id}}" />
        <button class="btn btn-sm btn-outline-secondary" (click)="setFacultyPassword(f.id)">Set Password</button>
        <button class="btn btn-sm btn-outline-danger" (click)="removeFaculty(f.id)">Remove</button>
      </div>
    </li>
  </ul>

  <hr class="my-4" />
  <h3 class="mb-3">Companies & Site Supervisors</h3>
  <div class="row g-3 align-items-end">
    <div class="col-md-5">
      <label class="form-label">Company Name</label>
      <input class="form-control" [(ngModel)]="company.name" name="cname2" />
    </div>
    <div class="col-md-5">
      <label class="form-label">Address</label>
      <input class="form-control" [(ngModel)]="company.address" name="caddr2" />
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" (click)="addCompany()">Add Company</button>
    </div>
  </div>
  <div class="row g-3 align-items-end mt-2">
    <div class="col-md-3">
      <label class="form-label">Site Supervisor</label>
      <input class="form-control" [(ngModel)]="site.name" name="sname2" />
    </div>
    <div class="col-md-3">
      <label class="form-label">Email</label>
      <input type="email" class="form-control" [(ngModel)]="site.email" name="semail2" />
    </div>
    <div class="col-md-4">
      <label class="form-label">Company</label>
      <select class="form-select" [(ngModel)]="site.companyId" name="scid2">
        <option [ngValue]="''">Select company...</option>
        <option *ngFor="let c of companyList()" [ngValue]="c.id">{{ c.name }}</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Password</label>
      <input type="password" class="form-control" [(ngModel)]="site.password" name="spass2" />
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-primary" (click)="addSite()">Add Site</button>
    </div>
  </div>
  <div class="table-responsive mt-3">
    <table class="table table-sm">
      <thead><tr><th>Company</th><th>Site Supervisor</th><th>Email</th><th>Password</th><th>Actions</th></tr></thead>
      <tbody>
        <tr *ngFor="let t of siteList()">
          <td>{{ companyName(t.companyId) }}</td>
          <td>{{ t.name }}</td>
          <td>{{ t.email }}</td>
          <td class="text-muted small">{{ t.password ? 'set' : 'not set' }}</td>
          <td>
            <div class="d-flex gap-2 align-items-center">
              <input class="form-control form-control-sm" style="width:160px" placeholder="New password" [(ngModel)]="siteNewPw[t.id]" name="spw{{t.id}}" />
              <button class="btn btn-sm btn-outline-secondary" (click)="setSitePassword(t.id)">Set Password</button>
              <button class="btn btn-sm btn-outline-danger" (click)="removeSite(t.id)">Remove</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="table-responsive mt-3">
    <table class="table table-sm">
      <thead><tr><th>Company</th><th>Address</th><th>Actions</th></tr></thead>
      <tbody>
        <tr *ngFor="let c of companyList()">
          <td>{{ c.name }}</td>
          <td>{{ c.address || '-' }}</td>
          <td><button class="btn btn-sm btn-outline-danger" (click)="removeCompany(c.id)">Remove</button></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
